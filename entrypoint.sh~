#!/usr/bin/env bash
set -euo pipefail

# Load env (Compose provides it, this is just to be explicit if running locally)
export $(grep -v '^#' .env.development | xargs) >/dev/null 2>&1 || true

echo "Waiting for database at ${DATABASE_URL} ..."
python - <<'PY'
import os, time
import psycopg2
from urllib.parse import urlparse

url = urlparse(os.environ.get("DATABASE_URL",""))
for _ in range(60):
    try:
        conn = psycopg2.connect(
            dbname=url.path.lstrip('/'),
            user=url.username, password=url.password,
            host=url.hostname, port=url.port or 5432,
            connect_timeout=2
        )
        conn.close()
        break
    except Exception:
        time.sleep(1)
else:
    raise SystemExit("Database never became ready.")
PY

echo "Applying migrations (if any)..."
poetry run flask db upgrade || true

echo "Starting Flask dev server..."
exec poetry run flask run --host=0.0.0.0 --port=5000 --debug
