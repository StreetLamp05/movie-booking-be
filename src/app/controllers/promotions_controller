from flask import request, jsonify
from sqlalchemy import asc, desc
from .. import db
from ..models.promotions import Promotion
from datetime import datetime



def _to_promo_row(p: Promotions):
    return {
        "promotion_id": str(p.promotion_id),
        "code": p.code,
        "description": p.description,
        "discount_percent": float(p.discount_percent),
        "starts_at": p.starts_at.isoformat() if p.starts_at else None,
        "ends_at": p.ends_at.isoformat() if p.ends_at else None,
        "created_at": u.created_at.isoformat() if u.created_at else None,
        "is_active": p.is_active,
        "max_uses": p.max_uses,
        "per_user_limit": p.per_user_limit,
    }


def create_promotion():
    data = request.get_json()
    
    # 1. Extract Data
    code = data.get('code')
    discount = data.get('discount_percent')
    start_str = data.get('starts_at') # Expecting format like "2025-12-01"
    end_str = data.get('ends_at')
    description = data.get('description')
    max_uses = data.get('max_uses')
    per_user_limit = data.get('per_user_limit')

    end_date = datetime.fromisoformat(end_str)

    # Get the current time in UTC (Standard for Docker/Servers)
    current_time = datetime.now(timezone.utc)

    # Ensure your input date also has timezone info
    if end_date.tzinfo is None:
        # If the frontend didn't send a timezone, assume UTC (or your server's local time)
        end_date = end_date.replace(tzinfo=timezone.utc)

    # NOW the comparison is accurate
    if end_date <= current_time:
        return jsonify({'error': 'End date must be in the future'}), 400

    # 2. Rubric Requirement: Validate Fields
    if not code or not discount or not start_str or not end_str:
        return jsonify({'error': 'Missing required fields'}), 400
        
    # 3. Rubric Requirement: Validate Discount (0-100%)
    try:
        discount = float(discount)
        if discount <= 0 or discount > 100:
            return jsonify({'error': 'Discount must be between 1% and 100%'}), 400
    except ValueError:
        return jsonify({'error': 'Invalid discount format'}), 400

    # 4. Parse Dates
    try:
        # Adjust format "%Y-%m-%d" based on what your frontend sends
        start_date = datetime.strptime(start_str, "%Y-%m-%d")
        end_date = datetime.strptime(end_str, "%Y-%m-%d")
    except ValueError:
        return jsonify({'error': 'Invalid date format. Use YYYY-MM-DD'}), 400

    # 5. CRITICAL RUBRIC POINT: Start < End Validation
    if start_date >= end_date:
        return jsonify({'error': 'End date must be after start date'}), 400
    
    if Promotion.query.filter_by(code=code).first():
        return jsonify({'error': 'Promotion code already exists'}), 400
    

        # 6. Save to DB
    new_promo = Promotion(
        code=code,
        description=description,
        discount_percent=discount,
        starts_at=start_date, 
        ends_at=end_date,
        is_active=True, 
        max_uses=max_uses,
        per_user_limit=per_user_limit
    )

    try:
        db.session.add(new_promo)
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        # This catches your CheckConstraints (e.g. if start > end)
        return jsonify({'error': str(e)}), 400

    return jsonify(new_promo.to_dict()), 201